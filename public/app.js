// !! CHANGE THIS to your backend Vercel URL if deploying separately !!
// e.g. const API_BASE = 'https://edutrack-api.vercel.app';
const API_BASE = '';

const PC = { 'HTML': { levels: 1, color: '#ff6b4a' }, 'CSS': { levels: 2, color: '#6b8fff' }, 'JavaScript': { levels: 3, color: '#f5c518' }, 'React JS': { levels: 3, color: '#61dafb' }, 'Node JS': { levels: 3, color: '#78c97a' } };
const LPL = 13;
let token = null, currentUser = null, currentView = 'v-landing', langFilter = 'all', progFilter = 'all', adminTab = 'overview', selectedStage = null, editingTeacherId = null, pendingDeleteTid = null, isLight = false;

async function api(method, path, body) { const opts = { method, headers: { 'Content-Type': 'application/json', ...(token ? { Authorization: 'Bearer ' + token } : {}) } }; if (body) opts.body = JSON.stringify(body); const res = await fetch(API_BASE + path, opts); const data = await res.json(); if (!res.ok) throw new Error(data.error || 'HTTP ' + res.status); return data; }
const skHTML = '<div class="sk"><div class="sk-dots"><div class="sk-dot"></div><div class="sk-dot"></div><div class="sk-dot"></div></div></div>';
const totalLessons = l => (PC[l]?.levels || 1) * LPL;
const totalDone = (lv, dim) => (lv - 1) * LPL + (dim || 0);
const pct = (d, t) => t ? Math.min(100, Math.round(d / t * 100)) : 0;
const tagCls = l => ({ HTML: 'HTML', CSS: 'CSS', JavaScript: 'JavaScript', 'React JS': 'React', 'Node JS': 'Node' }[l] || 'HTML');
const fmtDate = d => { if (!d) return '-'; const [y, m, dy] = d.split('-'); return dy + ' ' + ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][+m - 1] + ' ' + y; };
const emptyHTML = (t, m) => '<div class="empty-state"><div class="empty-line">' + t + '</div><p>' + m + '</p></div>';
const escAttr = s => String(s).replace(/'/g, '&#39;').replace(/"/g, '&quot;');

function buildLevelBar(g, mode = 'card') { const cfg = PC[g.lang] || { levels: 1 }; const lvls = cfg.levels; const done = totalDone(g.level, g.doneInLevel); const tl = totalLessons(g.lang); const op = pct(done, tl); if (mode === 'card') { const segs = Array.from({ length: lvls }, (_, i) => { const lv = i + 1, isDone = lv < g.level, isCur = lv === g.level; const fw = isDone ? 100 : isCur ? Math.min(100, Math.round(g.doneInLevel / LPL * 100)) : 0; return '<div class="level-seg' + (isCur ? ' level-seg-active' : '') + '"><div class="level-seg-fill' + (isDone ? ' done' : '') + '" style="width:' + fw + '%"></div><div class="level-seg-label ' + (fw >= 50 ? 'dark' : 'light') + '">LV' + lv + '</div></div>'; }).join(''); const ticks = Array.from({ length: lvls }, (_, i) => { const lv = i + 1, cls = lv < g.level ? 'done-tick' : lv === g.level ? 'active-tick' : ''; return '<div class="level-tick ' + cls + '">Level ' + lv + '<br><span style="font-size:8px;opacity:.6">' + ((lv - 1) * LPL + 1) + '-' + (lv * LPL) + '</span></div>'; }).join(''); return '<div class="level-bar-wrap"><div class="level-bar-title"><span class="level-bar-label">Level Progress &nbsp;&#183;&nbsp; ' + done + '/' + tl + ' lessons</span><span class="level-bar-pct">' + op + '%</span></div><div class="level-bar-track">' + segs + '</div><div class="level-ticks">' + ticks + '</div></div>'; } const segs = Array.from({ length: lvls }, (_, i) => { const lv = i + 1, isDone = lv < g.level, isCur = lv === g.level; const fw = isDone ? 100 : isCur ? Math.min(100, Math.round(g.doneInLevel / LPL * 100)) : 0; return '<div class="mini-seg' + (isCur ? ' active-seg' : '') + '"><div class="mini-seg-fill' + (isDone ? ' done' : '') + '" style="width:' + fw + '%"></div></div>'; }).join(''); return '<div class="mini-level-wrap"><div class="mini-level-bar">' + segs + '</div><div class="mini-level-info"><span class="mini-level-pct">' + op + '%</span><span class="mini-level-detail">Lv' + g.level + '/' + lvls + ' &nbsp;&#183;&nbsp; ' + g.doneInLevel + '/' + LPL + ' this level</span></div></div>'; }

function goTo(id) { document.getElementById(currentView).classList.remove('active'); document.getElementById(id).classList.add('active'); currentView = id; }

async function adminLogin() { const u = document.getElementById('al-user').value.trim(), p = document.getElementById('al-pass').value, errEl = document.getElementById('al-err'), btn = document.getElementById('al-btn'); if (!u || !p) return; btn.disabled = true; btn.textContent = 'Signing in...'; try { const data = await api('POST', '/api/auth/admin', { username: u, password: p }); token = data.token; errEl.classList.remove('show'); currentUser = { type: 'admin' }; document.getElementById('al-user').value = ''; document.getElementById('al-pass').value = ''; goTo('v-admin-app'); switchAdminTab('overview'); } catch { errEl.classList.add('show'); document.getElementById('al-pass').value = ''; } finally { btn.disabled = false; btn.textContent = 'Sign In to Admin Panel'; } }

async function teacherLogin() { const u = document.getElementById('tl-user').value.trim(), p = document.getElementById('tl-pass').value, errEl = document.getElementById('tl-err'), btn = document.getElementById('tl-btn'); if (!u || !p) return; btn.disabled = true; btn.textContent = 'Signing in...'; try { const data = await api('POST', '/api/auth/teacher', { username: u, password: p }); token = data.token; const teacher = data.teacher; errEl.classList.remove('show'); currentUser = { type: 'teacher', teacher }; document.getElementById('tl-user').value = ''; document.getElementById('tl-pass').value = ''; document.getElementById('t-nav-av').textContent = teacher.name.charAt(0); document.getElementById('t-nav-name').textContent = teacher.name; document.getElementById('t-sub').textContent = 'Welcome back, ' + teacher.name + ' - manage your groups below'; goTo('v-teacher-app'); renderTeacher(); } catch { errEl.classList.add('show'); document.getElementById('tl-pass').value = ''; } finally { btn.disabled = false; btn.textContent = 'Sign In to Teacher Panel'; } }

function logout() { token = null; currentUser = null; langFilter = 'all'; progFilter = 'all'; adminTab = 'overview'; goTo('v-landing'); }

function switchAdminTab(tab) { adminTab = tab;['overview', 'groups', 'teachers'].forEach(t => { document.getElementById('atab-' + t).classList.toggle('active', t === tab); document.getElementById('apanel-' + t).classList.toggle('active', t === tab); }); if (tab === 'overview') renderOverview(); if (tab === 'groups') renderGroups(); if (tab === 'teachers') renderTeachersTab(); }

async function renderOverview() { document.getElementById('admin-stats').innerHTML = skHTML; document.getElementById('admin-lang-summary').innerHTML = ''; try { const s = await api('GET', '/api/stats'); document.getElementById('admin-stats').innerHTML = '<div class="stat-card"><div class="stat-card-num">' + s.totalGroups + '</div><div class="stat-card-lbl">Groups</div></div><div class="stat-card"><div class="stat-card-num">' + s.totalTeachers + '</div><div class="stat-card-lbl">Teachers</div></div><div class="stat-card"><div class="stat-card-num">' + s.totalStudents + '</div><div class="stat-card-lbl">Students</div></div><div class="stat-card"><div class="stat-card-num">' + s.avgProgress + '%</div><div class="stat-card-lbl">Avg Progress</div></div><div class="stat-card"><div class="stat-card-num">' + s.byLang.filter(l => l.groups > 0).length + '</div><div class="stat-card-lbl">Languages</div></div>'; const langHtml = s.byLang.filter(l => l.groups > 0).map(l => { const cfg = PC[l.lang] || { levels: 1 }; return '<div style="background:var(--dark);border:1px solid var(--border);border-radius:var(--r);padding:20px 24px;display:flex;align-items:center;gap:20px;margin-bottom:12px;transition:border-color .2s" onmouseover="this.style.borderColor=\'var(--yborder)\'" onmouseout="this.style.borderColor=\'var(--border)\'"><span class="tag tag-' + tagCls(l.lang) + '" style="font-size:13px;padding:6px 14px">' + l.lang + '</span><div style="flex:1"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:14px;color:var(--gl)">' + l.groups + ' group' + (l.groups > 1 ? 's' : '') + ' &nbsp;&#183;&nbsp; ' + l.students + ' students &nbsp;&#183;&nbsp; ' + cfg.levels + ' level' + (cfg.levels > 1 ? 's' : '') + ' (' + (cfg.levels * LPL) + ' lessons)</span><span style="font-family:var(--fm);font-size:13px;color:var(--yellow);font-weight:700">' + l.avgPct + '%</span></div><div style="background:var(--dark2);border-radius:100px;height:5px;overflow:hidden"><div style="width:' + l.avgPct + '%;height:100%;background:' + (PC[l.lang]?.color || 'var(--yellow)') + ';border-radius:100px"></div></div></div></div>'; }).join(''); document.getElementById('admin-lang-summary').innerHTML = langHtml || emptyHTML('NO DATA', 'No groups yet.'); } catch (err) { document.getElementById('admin-stats').innerHTML = ''; showToast('Failed to load stats: ' + err.message, true); } }

function groupRow(g) { const cfg = PC[g.lang] || { levels: 1 }; const done = totalDone(g.level, g.doneInLevel); const tl = totalLessons(g.lang); return '<tr><td class="td-w">' + g.group + '</td><td><span class="tag tag-' + tagCls(g.lang) + '">' + g.lang + '</span></td><td><span style="font-family:var(--fm);font-size:11px;color:var(--yellow);background:var(--yglow);padding:4px 12px;border-radius:100px;border:1px solid var(--yborder);white-space:nowrap">Lv ' + g.level + '/' + cfg.levels + '</span></td><td class="td-m">' + g.time + '</td><td>' + fmtDate(g.start) + '</td><td>' + fmtDate(g.exam) + '</td><td class="td-n">' + g.students + '</td><td class="td-m">' + done + '/' + tl + '</td><td>' + buildLevelBar(g, 'table') + '</td></tr>'; }

async function renderGroups() { const el = document.getElementById('admin-groups-content'); el.innerHTML = skHTML; try { const [teachers, allGroups] = await Promise.all([api('GET', '/api/teachers'), api('GET', '/api/groups')]); let filtered = allGroups; if (langFilter !== 'all') filtered = filtered.filter(g => g.lang === langFilter); if (progFilter !== 'all') filtered = filtered.filter(g => { const p = pct(totalDone(g.level, g.doneInLevel), totalLessons(g.lang)); return progFilter === 'not-started' ? p === 0 : progFilter === 'in-progress' ? p > 0 && p < 100 : p === 100; }); if (!filtered.length) { el.innerHTML = emptyHTML('NO RESULTS', 'No groups match the selected filters.'); return; } el.innerHTML = teachers.map(t => { const gs = filtered.filter(g => g.tid === t.id); if (!gs.length) return ''; return '<div class="teacher-section"><div class="teacher-hdr"><div class="t-avatar">' + t.name.charAt(0) + '</div><div><div class="t-name-big">' + t.name + '<span class="t-badge">' + t.subject + '</span></div><div class="t-count">' + gs.length + ' group' + (gs.length > 1 ? 's' : '') + ' &nbsp;&#183;&nbsp; ' + gs.reduce((a, g) => a + g.students, 0) + ' students</div></div></div><div class="table-wrap"><table class="data-table"><thead><tr><th>Group</th><th>Language</th><th>Level</th><th>Time</th><th>Start</th><th>Exam</th><th>Students</th><th>Done</th><th>Progress</th></tr></thead><tbody>' + gs.map(g => groupRow(g)).join('') + '</tbody></table></div></div>'; }).join('') || emptyHTML('NO RESULTS', 'No groups match the selected filters.'); } catch (err) { el.innerHTML = emptyHTML('ERROR', 'Failed to load groups.'); showToast(err.message, true); } }

function setLangFilter(val, btn) { langFilter = val; document.querySelectorAll('#lang-filter-bar .filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderGroups(); }
function setProgFilter(val, btn) { progFilter = val; document.querySelectorAll('#prog-filter-bar .filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderGroups(); }

async function renderTeachersTab() { document.getElementById('teachers-grid').innerHTML = skHTML; document.getElementById('teachers-groups-content').innerHTML = ''; try { const [teachers, allGroups] = await Promise.all([api('GET', '/api/teachers'), api('GET', '/api/groups')]); if (!teachers.length) { document.getElementById('teachers-grid').innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-line">NO TEACHERS</div><p>Create your first teacher account above.</p></div>'; return; } document.getElementById('teachers-grid').innerHTML = teachers.map((t, i) => { const mg = allGroups.filter(g => g.tid === t.id); const ts = mg.reduce((a, g) => a + g.students, 0); const ap = mg.length ? Math.round(mg.reduce((a, g) => a + pct(totalDone(g.level, g.doneInLevel), totalLessons(g.lang)), 0) / mg.length) : 0; const grpRows = mg.length ? mg.map(g => { const p = pct(totalDone(g.level, g.doneInLevel), totalLessons(g.lang)); const cfg = PC[g.lang] || { levels: 1 }; return '<div class="tc-group-row"><span class="tag tag-' + tagCls(g.lang) + '" style="font-size:10px">' + g.lang + '</span><span class="tc-group-name">' + g.group + '</span><span style="font-size:10px;color:var(--gray);font-family:var(--fm);white-space:nowrap">Lv' + g.level + '/' + cfg.levels + '</span><div class="tc-group-prog"><div class="tc-mini-track"><div class="tc-mini-fill" style="width:' + p + '%"></div></div><span class="tc-group-pct">' + p + '%</span></div></div>'; }).join('') : '<div style="font-size:13px;color:var(--gray);text-align:center;padding:16px;font-family:var(--fm)">No groups assigned yet</div>'; return '<div class="teacher-card" style="animation-delay:' + (i * .05) + 's"><div class="tc-head"><div class="tc-avatar">' + t.name.charAt(0) + '</div><div><div class="tc-name">' + t.name + '</div><div class="tc-subject">' + t.subject + '</div><div class="tc-username">@' + t.username + '</div></div></div><div class="tc-body"><div class="tc-stats"><div class="tc-stat"><div class="tc-stat-num">' + mg.length + '</div><div class="tc-stat-lbl">Groups</div></div><div class="tc-stat"><div class="tc-stat-num">' + ts + '</div><div class="tc-stat-lbl">Students</div></div><div class="tc-stat"><div class="tc-stat-num">' + ap + '%</div><div class="tc-stat-lbl">Avg Prog</div></div></div><div style="font-size:10px;color:var(--gray);font-family:var(--fm);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">Groups</div><div class="tc-groups-list">' + grpRows + '</div></div><div class="tc-actions"><button class="btn-sm btn-sm-yellow" onclick="openEditTeacher(\'' + t.id + '\',\'' + escAttr(t.name) + '\',\'' + escAttr(t.username) + '\',\'' + escAttr(t.subject) + '\')">Edit</button><button class="btn-sm btn-sm-red" onclick="confirmDeleteTeacher(\'' + t.id + '\',\'' + escAttr(t.name) + '\',' + mg.length + ')">Delete</button></div></div>'; }).join(''); document.getElementById('teachers-groups-content').innerHTML = teachers.map((t, i) => { const mg = allGroups.filter(g => g.tid === t.id); const ts = mg.reduce((a, g) => a + g.students, 0); const ap = mg.length ? Math.round(mg.reduce((a, g) => a + pct(totalDone(g.level, g.doneInLevel), totalLessons(g.lang)), 0) / mg.length) : 0; const langBreak = [...new Set(mg.map(g => g.lang))].map(l => '<span class="tag tag-' + tagCls(l) + '" style="font-size:10px">' + l + '</span>').join(''); const rows = mg.length ? mg.map(g => groupRow(g)).join('') : '<tr><td colspan="9" style="text-align:center;padding:32px;color:var(--gray);font-family:var(--fm);font-size:13px">No groups yet</td></tr>'; return '<div style="margin-bottom:44px;animation:fadeU .4s ' + (i * .07) + 's ease both"><div class="tg-header"><div style="display:flex;align-items:center;gap:16px;flex:1"><div class="tg-avatar">' + t.name.charAt(0) + '</div><div><div style="font-size:20px;font-weight:700;color:var(--white)">' + t.name + '</div><div style="font-size:12px;color:var(--gray);font-family:var(--fm);margin-top:2px">@' + t.username + ' &nbsp;&#183;&nbsp; ' + t.subject + '</div></div></div><div style="display:flex;align-items:center;gap:16px;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end"><div style="display:flex;gap:6px">' + langBreak + '</div><div class="tg-meta-pills"><span class="tg-pill">' + mg.length + ' group' + (mg.length !== 1 ? 's' : '') + '</span><span class="tg-pill">' + ts + ' students</span><span class="tg-pill tg-pill-y">' + ap + '% avg</span></div></div></div><div class="table-wrap"><table class="data-table"><thead><tr><th>Group</th><th>Language</th><th>Level</th><th>Time</th><th>Start</th><th>Exam</th><th>Students</th><th>Done</th><th>Progress</th></tr></thead><tbody>' + rows + '</tbody></table></div></div>'; }).join(''); } catch (err) { document.getElementById('teachers-grid').innerHTML = emptyHTML('ERROR', 'Failed to load teachers.'); showToast(err.message, true); } }

async function renderTeacher() { const grid = document.getElementById('teacher-grid'); grid.innerHTML = skHTML; try { const groups = await api('GET', '/api/groups'); if (!groups.length) { grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-line">NO GROUPS</div><p>Add your first group above.</p></div>'; return; } grid.innerHTML = groups.map((g, i) => { const cfg = PC[g.lang] || { levels: 1 }; const done = totalDone(g.level, g.doneInLevel); const tl = totalLessons(g.lang); return '<div class="group-card" style="animation-delay:' + (i * .06) + 's"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px"><span class="tag tag-' + tagCls(g.lang) + '">' + g.lang + '</span><span style="font-family:var(--fm);font-size:11px;color:var(--yellow);background:var(--yglow);padding:3px 12px;border-radius:100px;border:1px solid var(--yborder)">Level ' + g.level + ' / ' + cfg.levels + '</span></div><div class="gc-name">' + g.group + '</div><div class="gc-meta">' + currentUser.teacher.name + ' &nbsp;&#183;&nbsp; ' + g.time + '</div><div class="gc-stats"><div class="stat-box"><div class="stat-lbl">Students</div><div class="stat-val">' + g.students + '</div></div><div class="stat-box"><div class="stat-lbl">Total Lessons</div><div class="stat-val">' + tl + '</div></div><div class="stat-box"><div class="stat-lbl">Done</div><div class="stat-val">' + done + '</div></div><div class="stat-box"><div class="stat-lbl">This Level</div><div class="stat-val">' + g.doneInLevel + ' / ' + LPL + '</div></div><div class="stat-box"><div class="stat-lbl">Start</div><div class="stat-val sm">' + fmtDate(g.start) + '</div></div><div class="stat-box"><div class="stat-lbl">Exam</div><div class="stat-val sm">' + fmtDate(g.exam) + '</div></div></div>' + buildLevelBar(g, 'card') + '</div>'; }).join(''); } catch (err) { grid.innerHTML = emptyHTML('ERROR', 'Could not load your groups.'); showToast(err.message, true); } }

function openGroupModal() { document.getElementById('groupModal').classList.add('open'); }
function closeGroupModal() { document.getElementById('groupModal').classList.remove('open'); selectedStage = null;['m-name', 'm-lang', 'm-time', 'm-start', 'm-exam', 'm-students'].forEach(id => document.getElementById(id).value = ''); document.getElementById('m-done').value = '0'; document.getElementById('stage-section').style.display = 'none'; document.getElementById('stage-info-bar').style.display = 'none'; }
document.getElementById('groupModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeGroupModal(); });
function onLangChange() { const lang = document.getElementById('m-lang').value; selectedStage = null; if (!lang) { document.getElementById('stage-section').style.display = 'none'; return; } document.getElementById('stage-section').style.display = 'block'; document.getElementById('stage-info-bar').style.display = 'none'; document.getElementById('stage-months-row').innerHTML = Array.from({ length: PC[lang].levels }, (_, i) => { const lv = i + 1; return '<button type="button" class="stage-btn" id="sbtn-' + lv + '" onclick="selectStage(' + lv + ',\'' + lang + '\')"><span class="sb-num">' + lv + '</span><span class="sb-lbl">Level ' + lv + '</span></button>'; }).join(''); }
function selectStage(lv, lang) { selectedStage = lv; document.querySelectorAll('.stage-btn').forEach(b => b.classList.remove('active')); document.getElementById('sbtn-' + lv).classList.add('active'); document.getElementById('si-month').textContent = lv; document.getElementById('si-lessons').textContent = ((lv - 1) * LPL + 1) + '-' + (lv * LPL); document.getElementById('si-total').textContent = PC[lang].levels * LPL; document.getElementById('stage-info-bar').style.display = 'flex'; }
async function submitGroup() { const name = document.getElementById('m-name').value.trim(), lang = document.getElementById('m-lang').value, time = document.getElementById('m-time').value, start = document.getElementById('m-start').value, exam = document.getElementById('m-exam').value, students = parseInt(document.getElementById('m-students').value), doneInLevel = parseInt(document.getElementById('m-done').value) || 0; if (!name || !lang || !time || !start || !exam || !students) { showToast('Please fill in all required fields', true); return; } if (!selectedStage) { showToast('Please select the current level', true); return; } if (new Date(exam) <= new Date(start)) { showToast('Exam date must be after start date', true); return; } if (doneInLevel > LPL) { showToast('Max ' + LPL + ' lessons per level', true); return; } const btn = document.getElementById('grp-submit'); btn.disabled = true; btn.textContent = 'Saving...'; try { await api('POST', '/api/groups', { group: name, lang, time, start, exam, students, level: selectedStage, doneInLevel }); closeGroupModal(); renderTeacher(); showToast('Group added successfully'); } catch (err) { showToast(err.message, true); } finally { btn.disabled = false; btn.textContent = 'Add Group'; } }

function openTeacherModal() { editingTeacherId = null; document.getElementById('tm-title').textContent = 'Create Teacher Account'; document.getElementById('tm-sub').textContent = 'Set up login credentials and subject'; document.getElementById('tm-submit').textContent = 'Create Account'; document.getElementById('tm-pass').placeholder = '••••••••';['tm-name', 'tm-username', 'tm-pass', 'tm-subject'].forEach(id => document.getElementById(id).value = ''); document.getElementById('tm-err').classList.remove('show'); document.getElementById('teacherModal').classList.add('open'); }
function openEditTeacher(tid, name, username, subject) { editingTeacherId = tid; document.getElementById('tm-title').textContent = 'Edit Teacher Account'; document.getElementById('tm-sub').textContent = 'Update credentials or subject'; document.getElementById('tm-submit').textContent = 'Save Changes'; document.getElementById('tm-pass').placeholder = 'Leave blank to keep current'; document.getElementById('tm-name').value = name; document.getElementById('tm-username').value = username; document.getElementById('tm-pass').value = ''; document.getElementById('tm-subject').value = subject; document.getElementById('tm-err').classList.remove('show'); document.getElementById('teacherModal').classList.add('open'); }
function closeTeacherModal() { document.getElementById('teacherModal').classList.remove('open'); editingTeacherId = null; }
document.getElementById('teacherModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeTeacherModal(); });
async function submitTeacher() { const name = document.getElementById('tm-name').value.trim(), username = document.getElementById('tm-username').value.trim(), password = document.getElementById('tm-pass').value, subject = document.getElementById('tm-subject').value.trim(), errEl = document.getElementById('tm-err'); if (!name || !username || !subject) { showToast('Please fill in all fields', true); return; } if (!editingTeacherId && !password) { showToast('Password is required for new accounts', true); return; } errEl.classList.remove('show'); const btn = document.getElementById('tm-submit'); btn.disabled = true; btn.textContent = 'Saving...'; try { if (editingTeacherId) { const body = { name, username, subject }; if (password) body.password = password; await api('PUT', '/api/teachers/' + editingTeacherId, body); showToast('Teacher account updated'); } else { await api('POST', '/api/teachers', { name, username, password, subject }); showToast('Teacher account created'); } closeTeacherModal(); renderTeachersTab(); } catch (err) { if (err.message?.toLowerCase().includes('taken') || err.message?.toLowerCase().includes('exists')) { errEl.classList.add('show'); } else { showToast(err.message, true); } } finally { btn.disabled = false; btn.textContent = editingTeacherId ? 'Save Changes' : 'Create Account'; } }

function confirmDeleteTeacher(tid, name, groupCount) { pendingDeleteTid = tid; document.getElementById('confirm-msg').innerHTML = 'Delete <strong>' + name + '</strong>?' + (groupCount ? ' This will also remove their <strong>' + groupCount + ' group' + (groupCount > 1 ? 's' : '') + '</strong>.' : '') + ' This cannot be undone.'; document.getElementById('confirm-ok').onclick = async () => { const btn = document.getElementById('confirm-ok'); btn.disabled = true; btn.textContent = 'Deleting...'; try { await api('DELETE', '/api/teachers/' + pendingDeleteTid); closeConfirm(); renderTeachersTab(); showToast('Teacher account deleted'); } catch (err) { showToast(err.message, true); } finally { btn.disabled = false; btn.textContent = 'Delete'; } }; document.getElementById('confirmModal').classList.add('open'); }
function closeConfirm() { document.getElementById('confirmModal').classList.remove('open'); pendingDeleteTid = null; }
document.getElementById('confirmModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeConfirm(); });

let toastTimer;
function showToast(msg, isErr = false) { const t = document.getElementById('toast'); document.getElementById('toast-msg').textContent = msg; t.classList.toggle('err', isErr); t.classList.add('show'); clearTimeout(toastTimer); toastTimer = setTimeout(() => t.classList.remove('show'), 3400); }

const SUN = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
const MOON = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
function toggleTheme() { isLight = !isLight; document.body.classList.toggle('light', isLight); document.querySelectorAll('.theme-icon').forEach(s => s.innerHTML = isLight ? MOON : SUN); }
